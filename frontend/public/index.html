<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1976d2" />
    <meta
      name="description"
      content="Vehicle Management System"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" crossorigin="use-credentials" href="%PUBLIC_URL%/manifest.json" />
    <title>Vehicle Management</title>
    <!-- Xử lý lỗi toàn cục -->
    <script>
      // Biến toàn cục để lưu trữ các lỗi
      window._errorsLog = [];
      window._errorFilters = {
        enabled: true,
        messagePortErrors: true,
        networkErrors: true,
        resourceErrors: true
      };
      
      // Kiểm tra tham số URL để bật/tắt bộ lọc lỗi
      function updateErrorFilters() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('nofilter')) {
          window._errorFilters.enabled = false;
        }
        if (urlParams.has('shownetwork')) {
          window._errorFilters.networkErrors = false;
        }
        if (urlParams.has('showport')) {
          window._errorFilters.messagePortErrors = false;
        }
      }
      updateErrorFilters();
      
      // Hàm kiểm tra xem lỗi có cần lọc không
      function shouldFilterError(message) {
        if (!window._errorFilters.enabled) return false;
        
        const messagePortPatterns = [
          'message port closed',
          'port closed',
          'extension context invalidated'
        ];
        
        const networkPatterns = [
          'Failed to load resource',
          'net::',
          'Network Error',
          'Failed to fetch',
          'NetworkError',
          'ChunkLoadError',
          'Loading CSS chunk',
          'Loading chunk',
          'The connection to'
        ];
        
        if (window._errorFilters.messagePortErrors && 
            messagePortPatterns.some(pattern => message.includes(pattern))) {
          return true;
        }
        
        if (window._errorFilters.networkErrors && 
            networkPatterns.some(pattern => message.includes(pattern))) {
          return true;
        }
        
        return false;
      }
      
      // Log lỗi một cách thông minh
      function logErrorSafely(error, type) {
        if (!window._errorsLog) window._errorsLog = [];
        
        // Nếu là cùng một lỗi lặp lại, chỉ tăng counter
        const similarError = window._errorsLog.find(e => 
          e.message === error.message && e.type === error.type
        );
        
        if (similarError) {
          similarError.count = (similarError.count || 1) + 1;
          similarError.lastTimestamp = new Date().toISOString();
          return;
        }
        
        // Giới hạn số lượng lỗi được lưu trữ (tối đa 100)
        if (window._errorsLog.length > 100) {
          window._errorsLog.shift();
        }
        
        window._errorsLog.push({
          ...error,
          count: 1,
          type: type,
          timestamp: new Date().toISOString()
        });
      }
      
      // Chặn tất cả lỗi console.error liên quan đến message port và 404
      (function() {
        const originalConsoleError = console.error;
        console.error = function(...args) {
          // Không log các lỗi đã lọc
          if (args.length > 0 && typeof args[0] === 'string') {
            const errorMsg = args[0];
            
            if (shouldFilterError(errorMsg)) {
              logErrorSafely({ message: errorMsg }, 'console.error');
              return;
            }
          }
          originalConsoleError.apply(console, args);
        };
        
        // Ghi đè console.warn
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
          if (args.length > 0 && typeof args[0] === 'string') {
            const warnMsg = args[0];
            if (shouldFilterError(warnMsg)) {
              logErrorSafely({ message: warnMsg }, 'console.warn');
              return;
            }
          }
          originalConsoleWarn.apply(console, args);
        };
      })();

      // Xử lý tất cả lỗi JS với event listeners
      window.addEventListener('error', function(event) {
        // Bắt lỗi JS
        if (event.message) {
          if (shouldFilterError(event.message)) {
            logErrorSafely({
              message: event.message,
              file: event.filename,
              line: event.lineno
            }, 'js.error');
            event.preventDefault();
            return false;
          }
        }
        
        // Bắt lỗi tài nguyên
        if (event.target && window._errorFilters.resourceErrors && (
            event.target.tagName === 'LINK' || 
            event.target.tagName === 'SCRIPT' || 
            event.target.tagName === 'IMG'
          )) {
          logErrorSafely({
            element: event.target.tagName,
            source: event.target.src || event.target.href
          }, 'resource.error');
          event.preventDefault();
          return false;
        }
      }, true);

      // Bắt tất cả promise rejection không xử lý
      window.addEventListener('unhandledrejection', function(event) {
        let message = 'Unknown promise error';
        if (event.reason) {
          if (typeof event.reason === 'string') {
            message = event.reason;
          } else if (event.reason.message) {
            message = event.reason.message;
          } else if (event.reason.stack) {
            message = event.reason.stack;
          }
        }
        
        if (shouldFilterError(message)) {
          logErrorSafely({ message: message }, 'promise.rejection');
          event.preventDefault();
          return false;
        }
      });

      // Biến cho biết đã truy cập vào trang trước đó hay chưa
      try {
        sessionStorage.setItem('app_visited', 'true');
      } catch (e) {
        console.warn('Không thể truy cập sessionStorage');
      }
      
      // Kiểm tra và sửa URL nếu cần
      function fixHistoryAndUrl() {
        if (window.location.pathname !== '/' && !window.location.pathname.includes('.')) {
          if (window.history && window.history.replaceState) {
            // Tạo URL mới không có hash fragment
            const newUrl = window.location.origin + window.location.pathname + window.location.search;
            window.history.replaceState(
              { path: newUrl }, 
              document.title, 
              newUrl
            );
            
            // Log thông tin
            logErrorSafely({
              from: window.location.href,
              to: newUrl
            }, 'url.fixed');
          }
        }
      }
      
      // Thêm tiện ích gỡ lỗi
      function addDebugTools() {
        if (window.location.search.includes('debug=true')) {
          var debugDiv = document.createElement('div');
          debugDiv.style.position = 'fixed';
          debugDiv.style.bottom = '10px';
          debugDiv.style.right = '10px';
          debugDiv.style.zIndex = '9999';
          debugDiv.style.background = 'rgba(0,0,0,0.7)';
          debugDiv.style.color = 'white';
          debugDiv.style.padding = '5px 10px';
          debugDiv.style.borderRadius = '4px';
          debugDiv.style.fontSize = '12px';
          debugDiv.style.cursor = 'pointer';
          debugDiv.textContent = 'Debug';
          debugDiv.addEventListener('click', function() {
            window.location.href = '/debug.html?errors=' + encodeURIComponent(JSON.stringify(window._errorsLog));
          });
          document.body.appendChild(debugDiv);
        }
      }
      
      // Chạy khi DOM đã tải
      document.addEventListener('DOMContentLoaded', function() {
        fixHistoryAndUrl();
        addDebugTools();
      });
    </script>
  </head>
  <body>
    <noscript>Bạn cần bật JavaScript để chạy ứng dụng này.</noscript>
    <div id="root"></div>
    <script>
      // Biến kiểm soát service worker
      window._serviceWorkerStatus = {
        registered: false,
        failed: false,
        errorMessage: null
      };
      
      // Đăng ký service worker - xử lý triệt để lỗi
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          // Hàm kiểm tra nếu có bản cập nhật mới của SW
          function checkForSWUpdate(registration) {
            registration.update()
              .then(() => console.log('Kiểm tra cập nhật SW'))
              .catch(err => {
                // Chỉ lưu lỗi, không làm gì thêm
                logErrorSafely({ message: err.message }, 'sw.update.error');
              });
          }
          
          // Hàm xử lý tin nhắn từ SW
          function setupSWMessageHandling() {
            navigator.serviceWorker.addEventListener('message', function(event) {
              if (event && event.data) {
                console.log('Nhận tin nhắn từ SW:', event.data);
              }
            });
            
            // Xử lý controller change
            navigator.serviceWorker.addEventListener('controllerchange', function() {
              console.log('SW mới đang điều khiển trang');
            });
          }
          
          // Hàm đăng ký SW
          function registerServiceWorker() {
            navigator.serviceWorker.register('/service-worker.js', { 
              scope: '/',
              updateViaCache: 'none'
            })
            .then(function(registration) {
              window._serviceWorkerStatus.registered = true;
              console.log('SW đăng ký thành công:', registration.scope);
              
              // Thiết lập kiểm tra định kỳ
              setInterval(() => checkForSWUpdate(registration), 60 * 60 * 1000);
              
              // Xử lý cài đặt mới
              registration.addEventListener('updatefound', function() {
                const newWorker = registration.installing;
                if (newWorker) {
                  newWorker.addEventListener('statechange', function() {
                    console.log('SW trạng thái mới:', newWorker.state);
                  });
                }
              });
            })
            .catch(function(error) {
              window._serviceWorkerStatus.failed = true;
              window._serviceWorkerStatus.errorMessage = error.message;
              
              logErrorSafely({ 
                message: error.message,
                stack: error.stack 
              }, 'sw.registration.error');
              
              console.log('Lỗi đăng ký SW:', error);
            });
          }
          
          // Thiết lập message handling trước
          setupSWMessageHandling();
          
          // Sau đó đăng ký SW
          registerServiceWorker();
        });
      }
      
      // Fix bug khi load lại trang trên mobile (đặc biệt là iOS)
      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }
      
      // Xử lý lỗi Fetch API - nếu fetch bị lỗi, thử lại với XMLHttpRequest
      const originalFetch = window.fetch;
      window.fetch = function() {
        return originalFetch.apply(this, arguments)
          .catch(function(err) {
            if (err && (
                err.message.includes('Failed to fetch') || 
                err.message.includes('NetworkError') ||
                err.message.includes('Network Error')
              )) {
              const url = arguments[0];
              const options = arguments[1] || {};
              
              // Log lỗi
              logErrorSafely({
                url: typeof url === 'string' ? url : (url.url || 'unknown'),
                message: err.message
              }, 'fetch.error');
              
              // Không thử lại với các method không phải GET
              if (options.method && options.method !== 'GET') {
                throw err;
              }
              
              // Thử lại với XHR cho các request GET
              return new Promise(function(resolve, reject) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', typeof url === 'string' ? url : url.url);
                
                // Thêm các headers từ fetch options
                if (options.headers) {
                  Object.entries(options.headers).forEach(([key, value]) => {
                    xhr.setRequestHeader(key, value);
                  });
                }
                
                xhr.onload = function() {
                  if (xhr.status >= 200 && xhr.status < 300) {
                    resolve(new Response(xhr.response, {
                      status: xhr.status,
                      statusText: xhr.statusText,
                      headers: new Headers({
                        'Content-Type': xhr.getResponseHeader('Content-Type') || 'text/plain'
                      })
                    }));
                  } else {
                    reject(new Error('XHR failed: ' + xhr.statusText));
                  }
                };
                xhr.onerror = function() {
                  reject(new Error('XHR network error'));
                };
                xhr.send();
              });
            }
            throw err;
          });
      };
    </script>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html> 